---
date: "2025-08-18T17-50-25Z"
tool: "Claude Code"
title: "bootstrap script"
branch: "main"
base_commit: "5caa162"
---

# Prompt
```
You are writing a POSIX-compatible Bash script named `bootstrap.sh` for the **existing** repository. The goal is to let someone clone the repo and get a local demo running with the current files (Jira mock + a minimal Playwright test), without inventing extra services.

## What exists in the repo today

- `external-mocks/jira/` with:
  - `server.mjs` (Express mock for Jira issue create)
  - `package.json` and `Dockerfile`
  - `logs/` and `fixtures/` folders
- Empty scaffolds:
  - `apps/api/`, `apps/web/`, `packages/telemetry/`, `infra/` (no code yet)
- CI may or may not exist; don’t depend on it.
## What the script must do (idempotently)
1. **Preflight checks**
- Print OS, Node, and pnpm versions.
- Require Node ≥ 18 (prefer 20+) and suggest install steps if not found.
- Require `pnpm` (or enable via `corepack` if present); exit with a clear message if neither available.
- Don’t require Docker for this script (the mock will run with `node`).
2. **Jira mock setup (local, not Docker)**
- `npm ci` in `external-mocks/jira` (only if `node_modules` is missing).
- Start the mock with `node server.mjs` **in the background**, write its PID to a temp file, and **wait** (poll `/_admin/requests`) up to 20s until it’s ready.
- If the mock is already listening on `http://127.0.0.1:8081/_admin/requests`, skip starting a new one.
- Register a `trap` to kill the PID on exit if the script started it.
3. **Playwright e2e (minimal demo)**
- Ensure folder structure: `tests/e2e/tests/`.
- Create `tests/e2e/playwright.config.ts` **only if missing** with:
  - HTML reporter to `tests/e2e/playwright-report`
  - `trace: "on-first-retry"`, `screenshot: "only-on-failure"`, `video: "retain-on-failure"`
- Create `tests/e2e/tests/jira-mock.spec.ts` **only if missing** with a single test that:
  - Resets the mock via `POST /_admin/reset`
  - Creates an issue via `POST /rest/api/3/issue` with a `x-request-id` header (use `crypto.randomUUID()` if available; otherwise a simple fallback).
  - Asserts `201` and then fetches `/_admin/requests`, confirming the last entry has path `/rest/api/3/issue` and the same `request_id`.
  - Uses `const JIRA = process.env.JIRA_BASE_URL || 'http://127.0.0.1:8081'`.
- In `tests/e2e`, add dev dependency `@playwright/test@latest` iff not installed (`pnpm add -D @playwright/test@latest`).
- Run `pnpm exec playwright install --with-deps` in `tests/e2e`.
   - Run tests with:
     ```
     JIRA_BASE_URL=http://127.0.0.1:8081 pnpm exec playwright test
     ```
- On completion, print the path to the HTML report folder.
4. **Output & next steps**
- Print a concise summary of actions (created files, started services, where to look).
- Print simple next steps (e.g., “open the HTML report”, “commit the new files”, “stop mock with: kill PID”).
- Exit non-zero on hard failures (e.g., mock failed to start or Playwright install failed).
## Script constraints
- **Idempotent**: do not overwrite existing files unless `FORCE=1` is set.
- Use standard Bash patterns: `set -Eeuo pipefail`, functions per step, safe heredocs, and `command -v` for checks.
- Never delete user files; only create missing files or append safe blocks.
- Use `curl` for the mock health check; do not introduce extra dependencies.
- Be friendly: clearly log what you’re doing and how to fix common issues.
## File headers
When writing any new file, prepend:
```cpp
//
// Generated by bootstrap.sh (Claude-assisted).
// If edited by hand, keep this header for attribution.
// 
```
## Deliverable
Return **only** the complete Bash script for `bootstrap.sh`. It should be ready to save and run with:
```bash
chmod +x bootstrap.sh
./bootstrap.sh
```
```

# Assistant output (optional)
```

```

# Notes
- [ ] Human-reviewed
- [ ] Tested in CI
